#!/bin/bash

echo2() { echo -e "$@" >&2; }

HandleHelp() {
    local arg
    for arg in "$@" ; do
        case "$arg" in
            -help  | -hel  | -he  | -h | --help | --hel | --he | --h)
                /bin/emacs --help
                exit
                ;;
        esac
    done
}

HandleSessionType() {
    local from to
    case "$XDG_SESSION_TYPE" in
        wayland) to=emacs-wayland ;;
        x11)     to=emacs ;;
        *)       echo2 "==> Session type '$XDG_SESSION_TYPE' not supported."; exit 1 ;;
    esac
    from="$(/bin/pacman -Qq emacs)"
    [ "$from" ] || exit 1
    if [ $to != $from ] ; then
        echo2 "==> Replacing package '$from' with '$to'. "
        sudo pacman -Rdd --noconfirm $from
        sudo pacman -S   --noconfirm $to
    fi
}

HandleGeometry() {
    case "$(xrandr | grep '*' | awk '{print $1}')" in
        1920x1080) echo 100x40 ;;
        3840x2160) echo 150x80 ;;
        *)         echo 80x25 ;;
    esac
}

Main() {
    HandleHelp "$@"
    HandleSessionType    # emacs has separate wayland and x11 versions

    /bin/emacs --reverse-video --geometry=$(HandleGeometry) "$@" 2>/dev/null &
}

Main "$@"
