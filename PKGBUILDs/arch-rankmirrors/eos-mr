#!/bin/bash

echo2()       { echo "$@" >&2; }
DIE()         { echo2 -e "==> $progname: error:\n    $1"; Usage; exit 1; }
WARN()        { echo2 -e "==> $progname: warning: $1"; }

GetCurrentCountry() { cc="$(show-location-info country)"; [ "$cc" ] ; }

TraverseMirrors() {
    local timeout_rank=10
    local mirrors_with_statefiles=$(echo "$mirrors" | sed "s|/\$repo/os/\$arch|/$syncfile|")
    echo "$mirrors_with_statefiles" | parallel "eos-mr-rank-mirror {} $timeout_rank $distro $time_as_datetime"
}

DumpOptions() {
    if [ "$lopts" ] ; then
        lopts=${lopts//:/}          # remove all : chars
        lopts="--${lopts//,/ --}"   # make all words as options with prefix "--"
    fi
    if [ "$sopts" ] ; then
        sopts=${sopts//:/}          # remove all : chars
        sopts=${sopts//?/ -&}       # make all letters as options with prefix "-"
        sopts=${sopts:1}            # remove the first space
    fi

    [ "$lopts$sopts" ] && echo $lopts $sopts
}

GetCountries() {
    local timeinfo="$HOME/.cache/$progname/timeinfo.txt"
    local now=$(date +%j)
    
    if [ -z "$reflector_list_countries" ] || [ "$(< "$timeinfo")" != "$now" ] ; then
        reflector_list_countries=$(reflector --list-countries) || DIE "cannot get list of countries"
        reflector_list_countries=$(echo "$reflector_list_countries" | tail -n +3)
    fi
}
ListCountryCodes() {
    GetCountries
    echo "$reflector_list_countries" | awk '{print $(NF-1)}'
    exit 0
}
ListCountryNames() {
    GetCountries
    echo "$reflector_list_countries" | sed -E 's|([A-Z].+[a-z]) .*|"\1"|'
    exit 0
}

Usage() {
    cat <<EOF
Rank Arch mirrors.

Usage: $progname [options] [URLs]

Options:
    --help                     This help.
    --country <country-list>   A comma separated list of country code(s) for ranking their mirrors.
                               Case insensitive. Example: "--country de,gb".
    --country-current          Add current country code for mirrors to rank.
    --list-country-codes       Show available country codes. See also: 'reflector --list-countries'.
    --ranking-data             Show ranking data too.

URLs:                          URL(s) of mirrors to rank.
EOF
}

Options() {
    local opts
    local lopts="country:,country-current,distro:,dump-options,help,list-country-codes,list-country-names,ranking-data"
    local sopts="c:d:hlr"

    opts="$(/usr/bin/getopt -o=$sopts --longoptions $lopts --name "$progname" -- "$@")" || DIE "getopt error"
    eval set -- "$opts"

    while true ; do
        case "$1" in
            --) shift; break ;;
            -h | --help)            Usage; exit 0 ;;
            -c | --country)         tmp="${2^^}"; countries+=( ${tmp//,/ } ); shift ;;   # must be country codes!
            -l | --country-current) GetCurrentCountry && countries+=($cc) ;;
            -d | --distro)          distro="$2"; shift ;;
            -r | --ranking-data)    ranking_data=yes ;;
            --dump-options)         DumpOptions; exit 0 ;;
            --list-country-codes)   ListCountryCodes; exit 0 ;;
            --list-country-names)   ListCountryNames; exit 0 ;;
        esac
        shift
    done
    urls+=("$@")
}

Main() {
    local progname=${0##*/}
    local distro=""             # arch or endeavouros
    local urls=() url
    local timeout=10
    local syncfile=""
    local mirrors
    local mirrorlist=""
    local time_as_datetime=no
    local ranking_data=no
    local countries=()          # contains only uppercase country codes
    local cc                    # current country
    local tmp
    local suffix=""
    local reflector_list_countries=""

    [ -x /bin/parallel ] || DIE "package 'parallel' is required"

    Options "$@"

    case "$distro" in
        "" | arch)
            distro=arch
            if [ ${#countries[@]} -eq 0 ] ; then
                echo2 "==> option --country not used -> automatically adding the current country for ranking, if possible"
                GetCurrentCountry && countries+=($cc) && echo2 "==> added: FI" || DIE "no countries given for ranking."
            fi
            mirrorlist=/etc/pacman.d/mirrorlist
            syncfile=lastupdate
            time_as_datetime=yes
            suffix='/$repo/os/$arch'
            url="https://archlinux.org/mirrorlist/?protocol=https&ip_version=4&use_mirror_status=on"
            for tmp in "${countries[@]}" ; do
                url+="&country=$tmp"
            done
            mirrors=$(curl -Lsm $timeout "$url" | grep "^#Server = " | awk '{print $NF}')
            ;;
        endeavouros)
            DIE "sorry, waiting for implementation!"
            mirrorlist=/etc/pacman.d/endeavouros-mirrorlist
            syncfile=state
            suffix='/$repo/$arch'
            # TODO: fetch endeavouros-mirrorlist !!
            mirrors=$(grep "^Server[ \t]*=[ \t]*" "$mirrorlist" | awk '{print $NF}')
            ;;
        *)  DIE "distro $distro not supported." ;;
    esac

    result=$(TraverseMirrors)

    local ranked=$(echo "$result" | column -t -s'|' | LC_ALL=C sort -k2rb,2 -k3b,3)   # sort: age

    ShowMirrorlist    "\n### ${distro^} mirror list, ranked by command:\n### $progname $*\n"
    ShowRankingResult "\n### Ranking data:"
}

ShowMirrorlist()    { echo -e "$1"; echo "$ranked" | awk '{print $1}' | sed -E "s|(.*)|Server = \1$suffix|"; }
ShowRankingResult() { [ $ranking_data = yes ] && { echo -e "$1"; echo "$ranked" | sed -E "s|^([^ ]+)|### \1$suffix|"; } ; }

Main "$@"
