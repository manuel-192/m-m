#!/bin/bash

DIE() {
    local progname="$(basename "$0")"
    echo "$progname: error: $1" >&2
    exit 1
}

Main()
{
    local RECURSE_SUBFOLDERS="no"
    local SUPPORTED_FOLDERS=(/usr/share/endeavouros/backgrounds)
    local SUPPORTED_SUFFIXES=(jpg png)
    local SEARCH_CASE_SENSITIVE="no"

    source /etc/wallpaper-changer.conf || return 1

    local opt_name="-iname"
    local opt_depth="-maxdepth 1"

    local cmd="" folder suffix
    local filelist=""

    [ "$SEARCH_CASE_SENSITIVE" = "yes" ] && opt_name="-name"
    [ "$RECURSE_SUBFOLDERS"    = "yes" ] && opt_depth=""

    for folder in "${SUPPORTED_FOLDERS[@]}" ; do
        for suffix in "${SUPPORTED_SUFFIXES[@]}" ; do
            if [ -z "$cmd" ] ; then
                cmd="find $folder $opt_depth $opt_name *.$suffix"
            else
                cmd+=" -o $opt_name *.$suffix"
            fi
        done
    done

    if [ -n "$cmd" ] ; then
        filelist=$($cmd)
        if [ -n "$filelist" ] ; then
            local count=$(echo "$filelist" | wc -l)
            local nr=$(shuf -i 1-$count -n1)
            local file=$(echo "$filelist" | sed -n "${nr}p")
            if [ -r "$file" ] ; then
                eos-wallpaper-set "$file"
            fi
        fi
    fi
}

Main "$@"
