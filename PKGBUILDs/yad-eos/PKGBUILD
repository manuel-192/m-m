#!/bin/bash

# Maintainer: manuel at EOS
# Maintainer: Christian Hesse <mail@eworm.de>
# Contributor: Aaron Fischer <mail@aaron-fischer.net>
# Contributor: Steven Allen <steven@stebalien.com>
# Contributor: trile7 at gmail dot com
# Contributor: Ernia <monghitri@aruba.it>

# started from pkgver 7.3

wget -q --timeout=10 -O PKGBUILD.yad \
     https://github.com/archlinux/svntogit-community/raw/packages/yad/trunk/PKGBUILD
sed -i PKGBUILD.yad \
    -e 's|cd "${srcdir}/${pkgname}-${pkgver}"|cd yad|'
sed -i PKGBUILD.yad \
    -e "/make DESTDIR=/a \  cd ../.. ; rm -rf yad"
source PKGBUILD.yad
rm -f PKGBUILD.yad

pkgver=8.0.r1.g06d526a
pkgname=yad-eos
source=(git+$url.git)
sha256sums=('SKIP')
provides=(yad)
conflicts=(yad yad-git)

pkgver() {
  cd yad
  git describe --long --tags | sed 's|v\([0-9\.]*\)-\([0-9]*\)-\([0-9a-f]*\)|\1.r\2.\3|'
}

prepare() {
    if (! grep -r "if (options.data.width > 0) {" >& /dev/null) ; then
        # patch 1 not found, so do it

        local pp="\n"

        pp+=" if (options.data.width > 0) {\n"
        pp+="   gtk_widget_set_size_request (vbox, options.data.width, options.data.height);\n"
        pp+=" } else {\n"
        pp+="     gint mw, nw;\n"
        pp+="     gtk_widget_get_preferred_width (vbox, &mw, &nw);\n"
        pp+="     gtk_widget_set_size_request (vbox, nw, -1);\n"
        pp+=" }\n"
        sed -i yad/src/main.c \
            -e "/gtk_widget_show_all (vbox);/a \ $pp"
    fi
}
