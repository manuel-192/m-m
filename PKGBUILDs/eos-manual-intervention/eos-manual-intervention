#!/bin/bash

# System hotfix manager.

echo2() { echo -e "$@" >&2; }
WARN()  { echo2 "$progname: warning: $1"; }
DIE()   { echo2 "$progname: error: $1"; exit 1; }

RUN() {
    echo2 "   ->" "$@"
    if "$@" ; then
        return 0
    else
        DIE "'$*' failed."
        exit 1
    fi
}

MarkOk() {
    echo2 "  ==> marking '$1' as handled"
    echo "$1" | sudo tee -a "$handled_fixes" >/dev/null
}
IsOk() { grep "^$1$" "$handled_fixes" &>/dev/null; }

FetchHotfixFile() {
    # TODO: fetch it
    if [ -e "$mifile" ] ; then
        sudo chmod -w "$mifile"
        source "$mifile"
    fi
}

RunFixesIfNeeded() {
    local count=${#MI_func_names[@]}
    local ix mifunc descr

    for ((ix=0; ix < count; ix+=2)) ; do
        mifunc="${MI_func_names[$ix]}"
        descr="${MI_func_names[$((ix+1))]}"
        if IsOk "$mifunc" ; then
            echo2 "$mifunc:\talready OK"
        else
            echo2 "$mifunc: $descr"
            if $mifunc ; then
                MarkOk "$mifunc"
            else
                return 1
            fi
        fi
    done
}

Disclaimer() {
    cat <<EOF >&2
NOTE: This program ($progname) is experimental meaning it may contain bugs.
      Please report any unexpected behavior at https://forum.endeavouros.com,
      the EndeavourOS forum.

EOF
}

Main() {
    local -r progname=${0##*/}
    local -r dir=/etc/$progname
    local -r mifile="$dir/$progname.interventions"
    local -r handled_fixes="$dir/handled.txt"
    local MI_func_names=()

    # Disclaimer

    sudo mkdir -p $dir

    FetchHotfixFile
    RunFixesIfNeeded
}

Main "$@"
