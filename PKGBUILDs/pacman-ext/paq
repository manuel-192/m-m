#!/bin/bash

# - pacman -Sy
# - show updates and their descriptions
# - pacman -Su

Cmd() {
    [ $verbose = yes ] && echo "==>" "$@" >&2
    "$@"
}

UpdateKeyrings() {
    local kr

    for kr in archlinux-keyring endeavouros-keyring ; do
        echo "$updates" | grep -w $kr >/dev/null && keyrings+=($kr)
    done
    [ ${#keyrings[@]} -gt 0 ] && Cmd pacman -S --noconfirm "${keyrings[@]}"
}

Main() {
    case "$(id)" in
        *'(root)'* | *'(wheel)'*)
            ;;
        *)  echo "Sorry, must use elevated privileges." >&2
            return 1
            ;;
    esac
    local verbose=yes
    local updates=""
    local keyrings=()

    Cmd pacman -Sy
    updates=$(pacman -Quq)         # updates=$(pacman -Su --print-format '%n')
    if [ -n "$updates" ] ; then
        UpdateKeyrings             # Update keyrings first,
        Cmd pacman -Su             # then other updates.
        Cmd hook-update-description $updates
    else
        echo "No updates." >&2
    fi

    # extras
    Cmd pacman -Qm
    Cmd eos-pacdiff
}

Main
