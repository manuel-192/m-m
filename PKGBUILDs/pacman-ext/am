#!/bin/bash

echo2()   { echo -e "$@" >&2; }
warning() { echo2 "$progname: $FUNCNAME: $1" ; }
error()   { echo2 "$progname: $FUNCNAME: $1" ; exit 1; }

assets_make() {
    local progname=${0##*/}
    local reponames_known=(m-aur2 m-more2 m-m endeavouros endeavouros-testing-dev)
    local reponame
    local curdir="$PWD"
    local options=(--fetch-timeout=120)
    local reponames_given=()
    local arg
    local mode="--dryrun"

    for arg in "$@" ; do
        case "$arg" in
            -b | --build)                                     mode="" ;;
            -n | -nl | -nn | -nr | --dryrun | --dryrun-local) mode="$arg" ;;
            -*) options+=("$arg") ;;
            *)  reponames_given+=("$arg") ;;
        esac
    done
    [ "$reponames_given" ] || error "give reponame(s)"
    if [ "$mode" ] ; then
        options+=("${mode}")
    fi

    for reponame in "${reponames_given[@]}" ; do
        if printf "%s\n" "${reponames_known[@]}" | grep "^$reponame$" >/dev/null ; then  # is known reponame?
            cd "$reponame"
            echo2 "==> assets.make ${options[*]}"
            assets.make ${options[*]}
            cd "$curdir"
        else
            warning "'$reponame' is not a known repository name"
        fi
    done
}

assets_make "$@"
