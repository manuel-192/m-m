#!/bin/bash

# System update - run using sudo.

# bright colors
RED=$'\e[0;91m'
GREEN=$'\e[0;92m'
BLUE=$'\e[0;94m'
MAGENTA=$'\e[0;95m'
CYAN=$'\e[0;96m'
RESET=$'\e[0m'       # back to normal

echo2()   { echo "$@" >&2 ; }
printf2() { printf "$@" >&2 ; }
CMSG()    { echo2 -n "$1"; printf2 "$progname: %s: %s\n\n" "$2" "$3" ; echo2 "$RESET"; }
DIE()     { CMSG "$RED"     error   "$1";  Options -h ; exit 1 ; }
WARN()    { CMSG "$BLUE"    warning "$1"; }
INFO()    { CMSG "$MAGENTA" info    "$1"; }
RESULT()  { echo2 " $1" ; }

EMPHASIZED2() {
    echo2 -n "${GREEN}==> "
    echo2 -n "$@"
    echo2 "${RESET}"
}

AsPlainUser() {
    case "$1" in
        -q | --quiet) local verbose=no; shift ;;
    esac
    local cmd=""
    case "$SUDO_USER" in
        "") cmd="/bin/runuser -u $PLAIN_USER -- $*" ;;
        *)  cmd="/bin/sudo -u $PLAIN_USER $*" ;;
    esac
    [ $verbose = yes ] && EMPHASIZED2 "$cmd:"
    $cmd
}

Cmd() {
    [ $verbose = yes ] && EMPHASIZED2 "$@:"
    "$@"
}

Cmd2() {
    local -r c_red=$'\e[0;91m'      # bright red color
    local -r c_reset=$'\e[0m'
    [ $verbose = yes ] && echo2 "${c_red}COMMAND: bash -c '$*'${c_reset}"
    bash -c "$*"
}

Xadditions() {
    local cmd="$1"
    if [ "$cmd" != ":" ] ; then
        cmd="${cmd#: && }"
        Cmd2 "$cmd"
    fi
}

InUpdates() { echo "$pacman_updates" | grep "^$1$" >/dev/null ; }
Installed() { expac -Q %n $1 >/dev/null ; }

UpdateKeyrings() {
    [ "$keyrings" = "yes" ] || return
    EMPHASIZED2 "Check keyrings."
    local keyr
    for keyr in archlinux-keyring endeavouros-keyring ; do
        InUpdates "$keyr" && Cmd pacman -S --noconfirm "$keyr"
    done
}

CheckNvidia() {
    [ "$nvidia" = "yes" ] || return
    EMPHASIZED2 "Check Nvidia & kernel."
    if InUpdates nvidia && ! InUpdates linux  ; then
        DIE "packages 'nvidia' and 'linux' must be updated together"
    fi
    if InUpdates nvidia-lts && ! InUpdates linux-lts  ; then
        DIE "packages 'nvidia-lts' and 'linux-lts' must be updated together"
    fi
}

CheckVirtualbox() {
    [ "$aur" = "yes" ] || return
    [ "$virtualbox" = "yes" ] || return
    EMPHASIZED2 "Check virtualbox."
    if InUpdates virtualbox ; then
        local version_vb=$(expac -S %v virtualbox)
        local version_vbext=$(LANG=C $helper -Si virtualbox-ext-oracle | grep "^Version")
        version_vbext=${version_vbext##* }
        [ "${version_vb%-*}" = "${version_vbext%-*}" ] || WARN "latest versions of virtualbox and virtualbox-ext-oracle do not match"
    fi        
}

CheckPrivileges() { [ "$EUID" = "0" ] || DIE "sorry, must run with elevated privileges." ; }

CheckDbLock() {
    [ "$lock_check" = "yes" ] || return
    EMPHASIZED2 "Check database lock."
    local lck=/var/lib/pacman/db.lck
    if [ -e $lck ] ; then
        if fuser $lck &>/dev/null ; then
            DIE "sorry, $lck is in use."
        fi
        Cmd rm -f $lck
    else
        RESULT "no lock."
    fi
}

CheckAUR() {
    [ "$aur" = "yes" ] || return
    if [ -x /bin/$helper ] ; then
        EMPHASIZED2 "Check AUR updates (as '$PLAIN_USER')."
        AsPlainUser --quiet $helper -Sua
    else
        WARN "'$helper' not installed, cannot check AUR updates."
    fi
}

Extras() {
    [ "$extras" = "yes" ] || return
    Cmd pacman -Qm  | sed 's|^| |'
    Cmd eos-pacdiff --indent=' '
}

CheckConnection() {
    [ "$connection" = "yes" ] || return
    if true ; then
        EMPHASIZED2 "Check connection (as '$PLAIN_USER')."
        AsPlainUser --quiet eos-connection-checker || DIE "no internet connection."
    else
        AsPlainUser eos-connection-checker && RESULT "internet connection OK." || DIE "no internet connection."
    fi
}

AppendCmd() { local -n _var="$1" ; _var+=" && $2" ; }

Defaults() {
    defaults=(
        aur        no
        connection no
        extras     no
        keyrings   yes
        nvidia     no
        verbose    yes
        virtualbox no
    )
    aur="${defaults[aur]}"
    connection="${defaults[connection]}"
    extras="${defaults[extras]}"
    keyrings="${defaults[keyrings]}"
    nvidia="${defaults[nvidia]}"
    verbose="${defaults[verbose]}"
    virtualbox="${defaults[virtualbox]}"
}

DumpOptions() {
    local l=" ${lopts//,/ }"
    l="${l//:/}"
    l="${l// / --}"
    l="${l:1}"
    local s=$(echo "$sopts" | sed -E 's|(.)[:]*| -\1|g')
    echo "$l$s"
    exit 0
}

Options() {
    local repo quiet
    Defaults
    [ "$aur"     = "yes" ] && repo=no  || repo=yes
    [ "$verbose" = "yes" ] && quiet=no || quiet=yes

    local lopts="aur,begin:,connection,dump-options,end:,extras,help,loud,middle:,no-keyrings"
    lopts+=",no-lock,nvidia,paru,quiet,repo,verbose,vb,virtualbox"
    local sopts="achnqrv"
    local opts
    opts="$(/usr/bin/getopt -o="$sopts" --longoptions "$lopts" --name "$progname" -- "$@")" || {
        Options -h
        return 1
    }
    eval set -- "$opts"

    while [ -n "$1" ] ; do
        case "$1" in
            -h | --help)
                cat <<EOF | column -t -s'|' -o"  "
Purpose:|Updater using pacman&yay
|+ more features.
Usage:|$progname [options]
Note:|sudo/root required.
Options:
|option|default|description
|~~~~~~|~~~~~~~|~~~~~~~~~~~
|-a, --aur|${defaults[aur]}|Update AUR packages too.
|-c, --connection|${defaults[connection]}|Check internet connection first.
|-h, --help||This help.
|-n, --nvidia|${defaults[nvidia]}|Check validity of nvidia & linux updates.
|    --no-keyrings|${defaults[keyrings]}|Do not update keyrings before other packages.
|    --no-lock||Do not check pacman database lock.
|    --paru||Use 'paru' instead of 'yay'. Implies --aur.
|-q, --quiet|$quiet|Be more quiet.
|-r, --repo|$repo|Only update native packages, not foreign (e.g. AUR).
|-v, --verbose, --loud|${defaults[verbose]}|Show what is being done.
|    --vb, --virtualbox|${defaults[virtualbox]}|Check validity of virtualbox updates in host.
advanced:
|    --begin||Adds the user-given command before 'pacman -Sy'.
|    --end||Adds the user-given command after 'pacman -Su'.
|    --middle||Adds the user-given command between 'pacman -Sy'
|||and 'pacman -Su'.
|    --extras|${defaults[extras]}|Run some predefined extras too.
EOF
                exit 0
                ;;
            --dump-options)          DumpOptions ;;
            -a | --aur)              aur=yes ;;
            -c | --connection)       connection=yes ;;
            -e | --extras)           extras=yes ;;
            --no-keyrings)           keyrings=no ;;
            --no-lock)               lock_check=no ;;
            -n | --nvidia)           nvidia=yes ;;
            --paru)                  helper=paru; aur=yes ;;
            -q | --quiet)            verbose=no ;;
            -r | --repo)             aur=no ;;
            -v | --verbose | --loud) verbose=yes ;;
            --vb | --virtualbox)     virtualbox=yes ;;
            --begin)                 AppendCmd begin  "$2" ; shift ;;
            --middle)                AppendCmd moddle "$2" ; shift ;;
            --end)                   AppendCmd end    "$2" ; shift ;;
        esac
        shift
    done
}

Main() {
    local -r progname="${0##*/}"
    local pacman_updates=""
    local aur connection extras keyrings nvidia quiet verbose virtualbox
    local helper=yay lock_check=yes
    local begin=":" end=":" middle=":"   # make there arrays !
    declare -A defaults=()
    local PLAIN_USER="$SUDO_USER"
    [ -z "$SUDO_USER" ] && PLAIN_USER="$LOGNAME"

    EMPHASIZED2 "COMMAND: $progname $*"

    Options "$@"

    CheckConnection
    CheckPrivileges
    CheckDbLock
    Xadditions "$begin"
    Cmd pacman -Sy
    if [ "$aur" = "yes" ] ; then
        pacman_updates=$($helper -Quq)
    else
        pacman_updates=$(pacman -Quq)
    fi

    if [ -n "$pacman_updates" ] ; then
        UpdateKeyrings
        CheckNvidia
        CheckVirtualbox
        Xadditions "$middle"
        Cmd pacman -Su
        Xadditions "$end"
    fi
    CheckAUR
    Extras
}

Main "$@"
