#!/bin/bash

# Enhance CDPATH and cd:
#   - if multiple matches, make round robin with them

DIE() {
    [ -n "$1" ] && echo "$@" >&2
    exit 1
}

AddUniqueMatch() {
    local d="$1"
    local m n
    for m in "${matches[@]}" ; do
        [ "$d" -ef "$m" ] && return
    done
    matches+=("$d")
}

ncd() {
    local newdir="$1"
    local dir matches=() ix count

    for dir in ${CDPATH//:/ } ; do
        if [ -d "$dir/$newdir" ] ; then
            AddUniqueMatch "$dir/$newdir"
        fi
    done
    count=${#matches[@]}
    case "$count" in
        0) dir="$newdir" ;;         # no match in CDPATH
        1) dir="${matches[0]}" ;;   # one match in CDPATH
        *)
            # many matches in CDPATH
            case "2" in
                1)
                    for ((ix=0; ix < count; ix++)) ; do
                        [ "${matches[$ix]}" -ef "$PWD" ] && break
                    done
                    [ $ix -ge $((count-1)) ] && ix=0 || ((ix++))
                    echo "($((ix+1))/$count)" >&2
                    dir="${matches[$ix]}"
                    ;;
                2)
                    dir=$(printf "%s\n" "${matches[@]}" | fzf  --no-separator --no-info --height=$((count+1)))
                    [ -n "$dir" ] || dir=.
                    ;;
            esac
            ;;
    esac

    echo "$dir"
}

Main()
{
    case "$1" in
        "")          ;;
        .* | /* | -) echo "$@" ;;
        -[LP@])      echo "$@" ;;   # ncd does not support options currently
        -*)          echo "$@" ;;   # error
        *)           ncd  "$@" ;;
    esac
}

Main "$@"
