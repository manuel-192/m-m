#!/bin/bash

# Check if package rebuilds are needed.

DIE() {
    local progname="$(basename "$0")"
    echo "$progname: error: $1" >&2
    Options -h
    exit 1
}

Options() {
    local progname="$(/usr/bin/basename "$0")"
    local opts

    opts="$(/usr/bin/getopt -o=h --longoptions help,build,dryrun-local,dryrun,allow-downgrade,repoup,reponames --name "$progname" -- "$@")" || {
        Options -h
        return 1
    }

    eval set -- "$opts"

    while true ; do
        case "$1" in
            --dryrun-local | --dryrun | --allow-downgrade | --repoup)
                opt="$1"
                ;;
            --build)
                opt=""
                ;;
            --reponames)
                echo "$reponames"
                exit 0
                ;;

            -h | --help)
                cat <<EOF >&2

Usage: $progname [operation] [options] [reponame]

Operations:
  --dryrun-local       Dryrun, don't download assets from remote (minimal dryrun).
                       Without a given operation this is the default.
  --dryrun             Dryrun, download assets from remote first (full dryrun).
  --repoup             Update only the database files (advanced).
  --build              Build and release updated packages (advanced).

Options:
  --allow-downgrade    New package is allowed to get a smaller version number (advanced).
                       By default updated packages must have a bigger version number.
Params:
  reponame             A name of a repository in /etc/pacman.conf.
                       Default: endeavouros

EOF
                exit 0
                ;;
            
            --) shift ; break ;;
        esac
        shift
    done

    [ -n "$1" ] && reponame="$1"

    if ! printf "%s\n" "$reponames" | grep "$reponame" >/dev/null ; then
        DIE "reponame '$reponame' is not supported."
    fi
}

pkgcheck() {
    local -r default_reponame="endeavouros"
    local -r default_opt="--dryrun-local"

    local reponame="$default_reponame"
    local opt="$default_opt"
    local reponames="$(pacconf --repo-list | grep -Pv 'core|extra|community|multilib')"

    Options "$@" || return $?

    source $HOME/.config/cd.conf || return $?
    source /etc/skel/cd.bash || return $?

    case "$reponame" in
        endeavouros)                        reponame=mirrors.mirror1 ;;
        endeavouros-testing-dev)            reponame=repo-testing.x86_64 ;;
        m-aur | m-m | m-more2 | local-repo) ;;
    esac

    pushd ~/ >/dev/null
    pushd $reponame >/dev/null
    case "$reponame" in
        local-repo) ./local-repo-manager ;;
        *) assets.make $opt ;;
    esac
    popd >/dev/null
    popd >/dev/null
}

pkgcheck "$@"
