#!/bin/bash
#
# Wrapper for pacman with some new features.
# Use option --help to see more.
#
# Author: manuel (see https://forum.endeavouros.com)

echo2() { echo "$@" >&2 ; }

DIE() {
    echo2 "$progname: error: $1"
    exit 1
}

CheckConnection() {
    if [ "$EOS_USE_CONNECTION_CHECK" = "yes" ] ; then
        /usr/bin/eos-connection-checker
        case "$?" in
            0) ;;
            *) DIE "Internet connection is not available! Please check." ;;
        esac
    fi
}

Check-kernel-nvidia() {
    local targets="$*"
    local target
    local linux_lts=no
    local linux=no
    local nvidia_lts=no
    local nvidia=no
    local nvidia_pkgs

    # stop if no nvidia package is already installed
    nvidia_pkgs="$(/usr/bin/pacman -Qq nvidia-dkms nvidia nvidia-lts 2>/dev/null)"
    [ -z "$nvidia_pkgs" ] && return

    # stop if nvidia-dkms is already installed
    [ -n "$(echo "$nvidia_pkgs" | /usr/bin/grep nvidia-dkms)" ] && return

    # stop if kernel will not be updated
    for target in $targets ; do
        case "$target" in
            linux)      linux=yes ;;
            linux-lts)  linux_lts=yes ;;
        esac
    done
    [ "$linux $linux_lts" = "no no" ] && return

    # notify if kernel will be updated but corresponding nvidia driver not
    for target in $targets ; do
        case "$target" in
            nvidia)     nvidia=yes ;;
            nvidia-lts) nvidia_lts=yes ;;
        esac
    done
    [ "$linux_lts $nvidia_lts" = "yes no" ] && DIE "linux-lts would be upgraded but nvidia-lts not."
    [ "$linux $nvidia" = "yes no" ]         && DIE "linux would be upgraded but nvidia not."
}


PacmanWrapper() {
    source /usr/share/endeavouros/scripts/eos-script-lib-yad || return 1
    source /etc/eos-pac.conf || return 1

    local sed=/usr/bin/sed
    local pacman=/usr/bin/pacman
    local checkupdates=/usr/bin/checkupdates
    local sync=/usr/bin/sync
    local yay=/usr/bin/yay
    local basename=/usr/bin/basename
    local cat=/usr/bin/cat
    local opts_pacman="-Syu"
    local opts_yay="-Syu --nocombinedupgrade"
    local updates
    local progname="$($basename "$0")"

    case "$1" in
        "")
            CheckConnection  # check only here, this is the most used operation here
	    
            updates=$($checkupdates)
	    if [ -n "$updates" ] ; then
		echo2 "$updates"
		echo2 ""
		Check-kernel-nvidia "$(echo "$updates" | awk '{print $1}')"
                echo2 "==> $($basename $pacman) $opts_pacman"
                $EOS_ROOTER "$pacman $opts_pacman && $sync"
            fi
            ;;
        *)
            local opt
            for opt in "$@" ; do
                case "$opt" in
                    --help)
                        local pacman_help=$(LANG=C $pacman "$@" | $sed -e "s|pacman |$progname |")
                        $cat <<EOF >&2
$progname is a pacman wrapper.

Changes/additions to pacman:
  - Asks root permissions only when needed.
  - If no parameters are given, runs 'pacman -Syu'.
  - New options:
      --aur | -a    Like with no parameters, but runs 'yay -Syu'.
                    If this option is used, other options and parameters will be ignored.

$pacman_help
EOF
                        return
                        ;;
                    --aur)
                        if [ -n "$($yay -Qua)" ] || ($checkupdates) ; then
                            echo2 "==> option $opt detected, ignoring other options and parameters."
                            echo2 "==> $($basename $yay) $opts_yay"
                            $yay $opts_yay && $sync
                        fi
                        return
                        ;;
                    --*) ;;
                    -*h*) $FUNCNAME --help "$@"; return ;;
                    -*a*) $FUNCNAME --aur ; return ;;
                esac
            done
            local rooterr="error: you cannot perform this operation unless you are root."
            local errfile=$(/usr/bin/mktemp)
            local errlog

            LANG=C $pacman "$@" 2> "$errfile"
            errlog="$($cat "$errfile")"
            /usr/bin/rm -f "$errfile"

            case "$errlog" in
                "$rooterr")
                    $EOS_ROOTER "LANG=C $pacman $* && $sync"
                    ;;
                "") ;;
                *)  echo2 "$errlog" ;;
            esac
            ;;
    esac
}

PacmanWrapper "$@"
