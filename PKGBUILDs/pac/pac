#!/bin/bash

Options() {
    local opts
    local lopts="nvidia,helper,help"
    local sopts="h"

    opts="$(/usr/bin/getopt -o=h --longoptions help,nvidia,helper: --name "$progname" -- "$@")" || {
        Options -h
        return 1
    }
    eval set -- "$opts"

    while true ; do
        case "$1" in
            --nvidia) nvidia=eos-kernel-nvidia-update-check ;;
            --helper) helper="$2" ; shift ;;

            -h | --help)
                cat <<EOF >&2
Usage: $progname [options]
Options:
  --help, -h         This help.
  --nvidia           Check also nvidia driver vs. kernel updates.
  --helper           AUR helper name (supported: yay, paru).
EOF
                exit 0
                ;;
            
            --) shift ; break ;;
        esac
        shift
    done
}

Main() {
    # Arch updater that handles lock file, keyrings, syncing, and optionally AUR with given AUR helper.
    
    ## Consider writing aliases to ~/.bashrc:
    # alias up='up2 pacman'
    # alias ur='up2 paru'
    # alias uy='up2 yay'

    local progname="$(/usr/bin/basename "$0")"
    local nvidia=":"
    local helper="pacman"

    local helper2=":"
    local lock=/var/lib/pacman/db.lck
    local rmopt=f

    Options "$@"

    echo "$helper update with additional and useful checks" >&2

    if [ -e $lock ] && fuser $lock &>/dev/null ; then
        rmopt=i
    fi
    local keyrings=(archlinux-keyring
                    endeavouros-keyring)
    if [ "$helper" = "pacman" ] ; then
        sudo bash -c "rm -$rmopt $lock; [ -e $lock ] || { $nvidia && pacman -Sy --noconfirm --needed ${keyrings[*]} && pacman -Su && sync ; }"
    else
        helper2="/usr/bin/sudo -u $LOGNAME $helper -Sua"
        sudo bash -c "rm -$rmopt $lock; [ -e $lock ] || { $nvidia && pacman -Sy --noconfirm --needed ${keyrings[*]} && pacman -Su && $helper2 ; sync ; }"
    fi
}

Main "$@"
