#!/bin/bash
#
# Wrapper for pacman:
#   - Asks for root permissions only when needed.
#   - Runs 'checkupdates && pacman -Syu' when parameters are not given.
#   - Supports updating from AUR too.
#
# Tip: make this an alias in your ~/.bashrc:
#   alias pac=_pacman_wrapper
#
# Author: manuel (see https://forum.endeavouros.com)

_pacman_wrapper() {
    case "$1" in
        "")
            checkupdates && { printf "Root "; su -c "pacman -Syu && sync"; }
            exit
            ;;
        -a | --aur)
            if [ -n "$(yay -Qua)" ] || (checkupdates) ; then
                yay -Syu --nocombinedupgrade && sync
            fi
            exit
            ;;
    esac

    local rooterr="error: you cannot perform this operation unless you are root."
    local errfile=$(mktemp)

    LANG=C pacman "$@" 2> "$errfile"
    errlog="$(cat "$errfile")"
    rm -f "$errfile"

    case "$errlog" in
        "$rooterr") su -c "LANG=C pacman $* && sync" ;;
        "") ;;
        *)  echo "$errlog" >&2 ;;
    esac
}

_pacman_wrapper "$@"
